#!/usr/bin/env bash

source $HOME/.config/debrewery/debrewery.cfg

repo=`basename $PWD | cut -f 1 -d '.'`
commitmessage=`git log -1 HEAD --pretty=format:%s`

echo $repo > /tmp/buildinfo

if [ -d /tmp/packages ]; then
    rm -f /tmp/packages/*
else
    mkdir /tmp/packages
fi

for distro in $DEBREW_DISTRIBUTIONS; do
    for arch in $DEBREW_ARCHITECTURES; do
        chroot /opt/chroot/$distro/$arch /usr/lib/debrewery/debrewery-agent.sh -d $distro -a $arch -u "`whoami`@`hostname -f`:$PWD" -r $repo -m $commitmessage &
    done
done

wait

cat /tmp/buildinfo
echo -e "\a"
